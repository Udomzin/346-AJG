<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add New Task</title>
    <link rel="stylesheet" href="project_detail.css"> 
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

    <style>
        /* Base Styles */
        :root {
            --bg-color: #333333;
            --app-bg: #1c1c1c; 
            --card-color: #2d2d2d;
            --text-color: #ffffff;
            --sub-text-color: #aaaaaa;
            --primary-color: #6366f1;
            --fab-color: #4f46e5; 
        }

        /* *** ส่วนที่ถูกเพิ่ม/แก้ไข: กำหนดพื้นหลังหลักของหน้าจอ *** */
        html, body {
            margin: 0;
            padding: 0;
            height: 100%;
            background-color: var(--app-bg); /* กำหนดให้พื้นหลังทั้งหน้าจอเป็นสีเข้ม */
            color: var(--text-color); 
            font-family: sans-serif;
        }
        /* ****************************************************** */

        /* 1. Form Container (FIXED Width and Background) */
        .add-task-form {
            padding: 20px;
            /* background-color: var(--app-bg); ถูกกำหนดที่ body แล้ว */
            min-height: 100vh;
            /* จำกัดความกว้างและจัดกึ่งกลาง */
            max-width: 600px; 
            margin: 0 auto; 
        }

        .add-task-header {
            display: flex;
            align-items: center;
            padding: 10px 0 20px 0;
        }

        .add-task-header h2 {
            font-size: 20px;
            font-weight: 600;
            margin-left: 15px;
            color: var(--text-color);
        }

        .back-btn {
            background: none;
            border: none;
            color: var(--text-color);
            font-size: 24px;
            cursor: pointer;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            color: var(--text-color);
            font-size: 16px;
            font-weight: 500;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .form-group input[type="text"],
        .form-group input[type="date"],
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #444;
            border-radius: 8px;
            background-color: #333;
            color: var(--text-color);
            font-size: 16px;
            box-sizing: border-box;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }
        
        /* 2. Priority Selector Styles */
        .priority-selection { 
            display: flex;
            gap: 12px;
            margin-top: 10px;
        }

        .priority-btn { 
            flex: 1; 
            background-color: var(--card-color);
            border: 1px solid transparent; 
            color: var(--sub-text-color);
            padding: 12px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s ease;
            font-weight: 500;
        }

        .priority-btn:hover {
            background-color: #3d3d3d;
            color: var(--text-color);
        }

        /* Active State Colors */
        .priority-btn[data-priority="Low"].selected { 
            border-color: #4CAF50; 
            color: #4CAF50; 
            background-color: rgba(76, 175, 80, 0.1); 
            font-weight: 600;
        }

        .priority-btn[data-priority="Medium"].selected {
            border-color: #FFC107; 
            color: #FFC107; 
            background-color: rgba(255, 193, 7, 0.1); 
            font-weight: 600;
        }

        .priority-btn[data-priority="High"].selected {
            border-color: #F44336; 
            color: #F44336; 
            background-color: rgba(244, 67, 54, 0.1); 
            font-weight: 600;
        }

        /* 3. Form Actions Styles */
        .form-actions { 
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 25px;
        }

        .form-actions button {
            width: 100%; 
        }
        
        .btn-full-width {
            padding: 15px;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            text-align: center;
        }

        .btn-primary-action {
            background-color: var(--primary-color);
            color: var(--text-color);
            border: none;
        }

        .btn-primary-action:hover {
            background-color: #4f46e5;
        }

        .btn-outline-action {
            background-color: transparent; 
            border: 1px solid var(--sub-text-color); 
            color: var(--sub-text-color); 
        }

        .btn-outline-action:hover {
            border-color: var(--text-color); 
            color: var(--text-color);
            background-color: rgba(255, 255, 255, 0.1); 
        }

        /* 4. Responsive (Desktop View) */
        @media (min-width: 768px) {
             .add-task-form {
                 min-height: auto; 
                 margin-top: 5vh; 
                 margin-bottom: 5vh;
                 border-radius: 12px;
             }
        }
    </style>
</head>
<body>
    <div class="add-task-form">
        <header class="add-task-header">
            <button class="back-btn" id="back-to-project"><i class="fas fa-arrow-left"></i></button>
            <h2>Add New Task</h2>
        </header>

        <form id="taskForm">
            <div class="form-group">
                <label for="taskName"><i class="fas fa-file-alt"></i> Task Name</label>
                <input type="text" id="taskName" placeholder="What needs to be done?" required>
            </div>

            <div class="form-group">
                <label for="description"><i class="fas fa-clipboard-list"></i> Description</label>
                <textarea id="description" placeholder="Add more details..."></textarea>
            </div>

            <div class="form-group">
                <label><i class="fas fa-exclamation-triangle"></i> Priority</label>
                <div class="priority-selection" id="prioritySelection">
                    <button type="button" class="priority-btn" data-priority="Low">Low</button>
                    <button type="button" class="priority-btn selected" data-priority="Medium">Medium</button>
                    <button type="button" class="priority-btn" data-priority="High">High</button>
                </div>
            </div>

            <div class="form-group">
                <label for="estimatedTime"><i class="fas fa-clock"></i> Estimated Time</label>
                <input type="text" id="estimatedTime" placeholder="e.g., 2 hours">
            </div>

            <div class="form-group">
                <label for="deadline"><i class="fas fa-calendar-alt"></i> Deadline</label>
                <input type="date" id="deadline">
            </div>
            
            <input type="hidden" id="projectIdInput"> 

            <div class="form-actions">
                <button type="submit" class="btn-full-width btn-primary-action">Add Task</button>
                <button type="button" class="btn-full-width btn-outline-action" id="cancelButton">Cancel</button>
            </div>
        </form>
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const projectId = urlParams.get('projectId');
            const backToProjectBtn = document.getElementById('back-to-project');
            const cancelButton = document.getElementById('cancelButton');
            const taskForm = document.getElementById('taskForm');
            const prioritySelection = document.getElementById('prioritySelection');
            let selectedPriority = 'Medium'; 

            document.getElementById('projectIdInput').value = projectId;

            // --- Priority Selection Logic ---
            prioritySelection.addEventListener('click', (e) => {
                if (e.target.classList.contains('priority-btn')) {
                    document.querySelectorAll('.priority-btn').forEach(btn => btn.classList.remove('selected'));
                    e.target.classList.add('selected');
                    selectedPriority = e.target.getAttribute('data-priority');
                }
            });

            // --- Navigation Logic ---
            const redirectToProjectDetail = () => {
                const targetUrl = projectId ? `project_detail.html?projectId=${projectId}` : `dashboard.html`;
                window.location.href = targetUrl;
            };

            backToProjectBtn.onclick = redirectToProjectDetail;
            cancelButton.onclick = redirectToProjectDetail;

            // --- Form Submission Logic ---
            taskForm.addEventListener('submit', (e) => {
                e.preventDefault();

                const taskName = document.getElementById('taskName').value.trim();
                const description = document.getElementById('description').value.trim();
                const estimatedTime = document.getElementById('estimatedTime').value.trim();
                const deadline = document.getElementById('deadline').value;
                
                if (!taskName) {
                    alert("Please enter a Task Name.");
                    return;
                }

                const newTask = {
                    id: Date.now().toString(), 
                    projectId: projectId,
                    name: taskName,
                    description: description,
                    priority: selectedPriority, 
                    estimatedTime: estimatedTime,
                    deadline: deadline,
                    status: 'To Do' 
                };

                // Save task to localStorage
                const allTasks = JSON.parse(localStorage.getItem('tasks')) || [];
                allTasks.push(newTask);
                localStorage.setItem('tasks', JSON.stringify(allTasks));

                alert(`Task '${taskName}' created successfully!`);
                
                redirectToProjectDetail();
            });
        });
    </script>
</body>
</html>