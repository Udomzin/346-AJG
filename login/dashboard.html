<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TaskSplit - Dashboard</title>
    
    <!-- เชื่อมต่อ Font Awesome สำหรับไอคอน -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <!-- เชื่อมต่อไฟล์ CSS หลัก -->
    <link rel="stylesheet" href="dashboard.css">
</head>
<body>
    <!-- คอนเทนเนอร์หลักของหน้า Dashboard -->
    <div class="page-wrapper">
        <div class="dashboard-container">
            
            <!-- ====================================
                 ส่วนหัว: ข้อมูลผู้ใช้ + ปุ่ม Logout
                 ==================================== -->
            <header class="header">
                <div class="user-info">
                    <!-- Avatar -->
                    <div class="avatar">JD</div>
                    
                    <!-- ข้อมูลผู้ใช้ -->
                    <div class="user-details">
                        <span class="user-email">user@example.com</span>
                        <span class="project-count">0 project</span>
                    </div>
                </div>

                <!-- ปุ่มออกจากระบบ -->
                <button class="logout-btn" id="logoutBtn" title="Logout">
                    <i class="fas fa-sign-out-alt"></i>
                    <span>Logout</span>
                </button>
            </header>

            <!-- ====================================
                 แถบค้นหาโปรเจค
                 ==================================== -->
            <div class="search-bar">
                <i class="fas fa-search"></i>
                <input type="text" id="searchInput" placeholder="Search workspaces...">
            </div>

            <!-- ====================================
                 พื้นที่แสดงโปรเจค
                 ==================================== -->
            <main class="main-content">
                <div id="dashboard-projects"></div>
            </main>

            <!-- ====================================
                 ปุ่มสร้างโปรเจค (FAB)
                 ==================================== -->
            <a href="create_project.html" class="fab" title="Create New Project">
                <i class="fas fa-plus"></i>
            </a>

        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {

    // ====================================
    // ดึง Elements จากหน้าเว็บ
    // ====================================
    const dashboardContainer = document.getElementById('dashboard-projects');
    const avatarElement = document.querySelector('.avatar');
    const userEmailElement = document.querySelector('.user-email');
    const projectCountElement = document.querySelector('.project-count');
    const searchInput = document.getElementById('searchInput');
    const logoutBtn = document.getElementById('logoutBtn');

    // ====================================
    // ตรวจสอบการล็อกอิน
    // ====================================
    const token = localStorage.getItem('currentUserToken') ||
                  sessionStorage.getItem('currentUserToken');

    if (!token) {
        alert('คุณยังไม่ได้ล็อกอิน!');
        window.location.href = 'login.html';
        return;
    }

    // ====================================
    // ดึงข้อมูลผู้ใช้ปัจจุบัน
    // ====================================
    const users = JSON.parse(localStorage.getItem('users')) || [];
    const currentUser = users.find(u => u.token === token);

    if (!currentUser) {
        alert('ผู้ใช้ไม่ถูกต้อง!');
        window.location.href = 'login.html';
        return;
    }

    // ====================================
    // แสดงข้อมูลผู้ใช้
    // ====================================
    userEmailElement.textContent = currentUser.email;
    avatarElement.textContent = currentUser.fullName
        .split(' ')
        .map(n => n[0])
        .join('')
        .toUpperCase();

    // ====================================
    // ฟังก์ชันสร้าง ID สุ่ม
    // ====================================
    function generateId() {
        return Math.random().toString(36).substring(2, 9);
    }

    // ====================================
    // โหลดข้อมูลโปรเจค
    // ====================================
    let projects = JSON.parse(localStorage.getItem('projects')) || [];

    projects = projects.map(p => {
        if (!p.id) {
            p.id = generateId();
        }
        return p;
    });

    localStorage.setItem('projects', JSON.stringify(projects));

    // ====================================
    // คัดเฉพาะโปรเจคของผู้ใช้
    // ====================================
    let userProjects = projects.filter(p => p.ownerToken === token);

    projectCountElement.textContent =
        `${userProjects.length} project${userProjects.length !== 1 ? 's' : ''}`;

    // ====================================
    // แสดงโปรเจค
    // ====================================
    function renderProjects(filteredProjects = userProjects) {
        dashboardContainer.innerHTML = '';

        if (filteredProjects.length === 0) {
            dashboardContainer.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-folder-open"></i>
                    <p>No projects found.</p>
                </div>
            `;
            return;
        }

        filteredProjects.forEach(p => {
            const card = document.createElement('div');
            card.className = 'project-card';

            card.onclick = (e) => {
                if (e.target.tagName !== 'BUTTON') {
                    window.location.href = 'project_detail.html?projectId=' + p.id;
                }
            };

            card.innerHTML = `
                <h3>${p.name}</h3>
                <div class="description">${p.description || '<i>No description</i>'}</div>
                <div class="project-info">
                    <i class="fas fa-users"></i>
                    <span>Max Members: ${p.maxMembers}</span>
                </div>
                <button onclick="event.stopPropagation(); deleteProject('${p.id}')">
                    <i class="fas fa-trash"></i> Delete
                </button>
            `;

            dashboardContainer.appendChild(card);
        });
    }

    // ====================================
    // ฟีเจอร์ค้นหา
    // ====================================
    searchInput.addEventListener('input', e => {
        const term = e.target.value.toLowerCase();

        const filtered = userProjects.filter(p =>
            p.name.toLowerCase().includes(term) ||
            (p.description && p.description.toLowerCase().includes(term))
        );

        renderProjects(filtered);
    });

    renderProjects();

    // ====================================
    // ลบโปรเจค
    // ====================================
    window.deleteProject = projectId => {
        if (!confirm('Are you sure you want to delete this project?')) return;

        const index = projects.findIndex(p => p.id === projectId);

        if (index !== -1) {
            projects.splice(index, 1);
            localStorage.setItem('projects', JSON.stringify(projects));

            userProjects = projects.filter(p => p.ownerToken === token);
            projectCountElement.textContent =
                `${userProjects.length} project${userProjects.length !== 1 ? 's' : ''}`;

            renderProjects();
        }
    };

    // ====================================
    // Logout
    // ====================================
    logoutBtn.addEventListener('click', () => {
        if (confirm('Are you sure you want to logout?')) {
            localStorage.removeItem('currentUserToken');
            sessionStorage.removeItem('currentUserToken');
            window.location.href = 'login.html';
        }
    });

});
</script>
</body>
</html>
