<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project Detail - TaskSplit</title>
    
    <!-- เชื่อมต่อ Font Awesome สำหรับไอคอน -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <!-- เชื่อมต่อไฟล์ CSS หลัก -->
    <link rel="stylesheet" href="project_detail.css">
</head>
<body>
    <!-- คอนเทนเนอร์หลัก -->
    <div class="container">
        
        <!-- ====================================
             ส่วนหัวของหน้า
             ==================================== -->
        <div class="header">
            <!-- ปุ่มย้อนกลับ -->
            <button class="back-btn" id="backBtn">
                <i class="fas fa-arrow-left"></i>
            </button>
            
            <!-- ข้อมูลโปรเจคตรงกลาง -->
            <div class="header-center">
                <h1 class="project-title" id="projectTitle">Loading...</h1>
                <p class="project-info" id="projectInfo">ID: ... | Max Members: ...</p>
            </div>
            
            <!-- ปุ่มเมนู 3 จุด -->
            <button class="menu-btn" id="menuBtn">
                <i class="fas fa-ellipsis-v"></i>
                
                <!-- Dropdown Menu -->
                <div class="dropdown-menu" id="dropdownMenu">
                    <div class="dropdown-item" id="deleteProject">
                        <i class="fas fa-trash"></i>
                        Delete Project
                    </div>
                </div>
            </button>
        </div>

        <!-- ====================================
             การ์ดแสดงความคืบหน้า (Progress Card)
             ==================================== -->
        <div class="progress-card">
            <div class="progress-header">
                <span class="progress-title">Overall Progress</span>
                <i class="fas fa-chart-line progress-icon"></i>
            </div>
            
            <!-- สถิติแบ่งเป็น 3 คอลัมน์ -->
            <div class="progress-stats">
                <!-- To Do -->
                <div class="stat-item">
                    <span class="stat-number" id="todoCount">0</span>
                    <span class="stat-label">To Do</span>
                </div>
                
                <!-- In Progress -->
                <div class="stat-item">
                    <span class="stat-number" id="inProgressCount">0</span>
                    <span class="stat-label">In Progress</span>
                </div>
                
                <!-- Done -->
                <div class="stat-item">
                    <span class="stat-number" id="doneCount">0</span>
                    <span class="stat-label">Done</span>
                </div>
            </div>
        </div>

        <!-- ====================================
             ส่วนแสดงรายการ Tasks
             ==================================== -->
        <div class="tasks-section">
            <h2 class="section-title">Recent Activity / Tasks</h2>
            
            <!-- รายการ Tasks (จะถูกสร้างโดย JavaScript) -->
            <div class="tasks-list" id="tasksList">
                <!-- Empty State (แสดงเมื่อไม่มี Task) -->
                <div class="empty-state">
                    <i class="fas fa-clipboard-list"></i>
                    <p>No tasks yet. Add one with the '+' button.</p>
                </div>
            </div>
        </div>

        <!-- ====================================
             ปุ่ม FAB สำหรับเพิ่ม Task
             ==================================== -->
        <button class="fab" id="addTaskBtn">
            <i class="fas fa-plus"></i>
        </button>
    </div>

    <!-- ====================================
         JavaScript สำหรับจัดการหน้า Project Detail
         ==================================== -->
    <script>
        // ====================================
        // 1. ดึง Project ID จาก URL
        // ====================================
        const urlParams = new URLSearchParams(window.location.search);
        const projectId = urlParams.get('projectId');

        // ตรวจสอบว่ามี Project ID หรือไม่
        if (!projectId) {
            alert('Project not found!');
            window.location.href = 'dashboard.html';
        }

        // ====================================
        // 2. โหลดข้อมูลโปรเจค
        // ====================================
        const projects = JSON.parse(localStorage.getItem('projects')) || [];
        const project = projects.find(p => p.id === projectId);

        // ตรวจสอบว่าพบโปรเจคหรือไม่
        if (!project) {
            alert('Project not found!');
            window.location.href = 'dashboard.html';
        }

        // ====================================
        // 3. แสดงข้อมูลโปรเจค
        // ====================================
        document.getElementById('projectTitle').textContent = project.name;
        document.getElementById('projectInfo').textContent = 
            `ID: ${projectId} | Max Members: ${project.maxMembers}`;

        // ====================================
        // 4. โหลดข้อมูล Tasks
        // ====================================
        let allTasks = JSON.parse(localStorage.getItem('tasks')) || [];
        let projectTasks = allTasks.filter(t => t.projectId === projectId);

        // ====================================
        // 5. ฟังก์ชันอัพเดทความคืบหน้า
        // ====================================
        function updateProgress() {
            // นับจำนวน Task แต่ละสถานะ
            const todo = projectTasks.filter(t => t.status === 'To Do').length;
            const inProgress = projectTasks.filter(t => t.status === 'In Progress').length;
            const done = projectTasks.filter(t => t.status === 'Done').length;

            // อัพเดทตัวเลขบนหน้าเว็บ
            document.getElementById('todoCount').textContent = todo;
            document.getElementById('inProgressCount').textContent = inProgress;
            document.getElementById('doneCount').textContent = done;
        }

        // ====================================
        // 6. ฟังก์ชันแสดงรายการ Tasks
        // ====================================
        function renderTasks() {
            const tasksList = document.getElementById('tasksList');
            
            // ถ้าไม่มี Task แสดง Empty State
            if (projectTasks.length === 0) {
                tasksList.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-clipboard-list"></i>
                        <p>No tasks yet. Add one with the '+' button.</p>
                    </div>
                `;
                return;
            }

            // สร้าง HTML สำหรับแต่ละ Task
            tasksList.innerHTML = projectTasks.map(task => {
                const priorityClass = task.priority.toLowerCase();
                const statusClass = task.status.toLowerCase().replace(' ', '-');
                
                return `
                    <div class="task-item priority-${priorityClass}" data-task-id="${task.id}">
                        <div class="task-info">
                            <div class="task-name">${task.name}</div>
                            <div class="task-details">
                                <span>Priority: ${task.priority}</span>
                                ${task.deadline ? `<span><i class="fas fa-calendar"></i> ${task.deadline}</span>` : ''}
                                ${task.assignedToName ? `<span><i class="fas fa-user"></i> ${task.assignedToName}</span>` : ''}
                            </div>
                        </div>
                        <span class="status-badge ${statusClass}">${task.status}</span>
                    </div>
                `;
            }).join('');

            // เพิ่ม Event Listener ให้แต่ละ Task
            document.querySelectorAll('.task-item').forEach(item => {
                item.addEventListener('click', (e) => {
                    const taskId = item.getAttribute('data-task-id');
                    changeTaskStatus(taskId);
                });
            });
        }

        // ====================================
        // 7. ฟังก์ชันเปลี่ยนสถานะ Task
        // ====================================
        function changeTaskStatus(taskId) {
            // หา Task ที่ต้องการเปลี่ยนสถานะ
            const taskIndex = allTasks.findIndex(t => t.id === taskId);
            if (taskIndex === -1) return;

            const task = allTasks[taskIndex];
            
            // วนสถานะ: To Do → In Progress → Done → To Do
            const statuses = ['To Do', 'In Progress', 'Done'];
            const currentIndex = statuses.indexOf(task.status);
            const nextIndex = (currentIndex + 1) % statuses.length;
            
            // เปลี่ยนสถานะ
            task.status = statuses[nextIndex];
            
            // บันทึกลง localStorage
            localStorage.setItem('tasks', JSON.stringify(allTasks));

            // อัพเดทหน้าเว็บ
            projectTasks = allTasks.filter(t => t.projectId === projectId);
            updateProgress();
            renderTasks();
        }

        // ====================================
        // 8. ปุ่มย้อนกลับ
        // ====================================
        document.getElementById('backBtn').addEventListener('click', () => {
            window.location.href = 'dashboard.html';
        });

        // ====================================
        // 9. เมนู Dropdown (จุด 3 จุด)
        // ====================================
        const menuBtn = document.getElementById('menuBtn');
        const dropdownMenu = document.getElementById('dropdownMenu');

        // เปิด/ปิดเมนู
        menuBtn.addEventListener('click', (e) => {
            e.stopPropagation(); // ป้องกันไม่ให้ปิดทันที
            dropdownMenu.classList.toggle('show');
        });

        // ปิดเมนูเมื่อคลิกที่อื่น
        document.addEventListener('click', () => {
            dropdownMenu.classList.remove('show');
        });

        // ====================================
        // 10. ฟังก์ชันลบโปรเจค
        // ====================================
        document.getElementById('deleteProject').addEventListener('click', () => {
            // ถามยืนยัน
            if (confirm(`Are you sure you want to delete "${project.name}"?`)) {
                // ลบโปรเจค
                const projectIndex = projects.findIndex(p => p.id === projectId);
                if (projectIndex !== -1) {
                    projects.splice(projectIndex, 1);
                    localStorage.setItem('projects', JSON.stringify(projects));
                }

                // ลบ Tasks ทั้งหมดของโปรเจค
                allTasks = allTasks.filter(t => t.projectId !== projectId);
                localStorage.setItem('tasks', JSON.stringify(allTasks));

                alert('Project deleted successfully!');
                window.location.href = 'dashboard.html';
            }
        });

        // ====================================
        // 11. ปุ่มเพิ่ม Task (FAB)
        // ====================================
        document.getElementById('addTaskBtn').addEventListener('click', () => {
            window.location.href = `add_task.html?projectId=${projectId}`;
        });

        // ====================================
        // 12. เริ่มต้นแสดงผล
        // ====================================
        updateProgress();
        renderTasks();
    </script>
</body>
</html>