<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>TaskSplit - Create Project</title>
    
    <!-- เชื่อมต่อ Font Awesome สำหรับไอคอน -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />
    
    <!-- เชื่อมต่อไฟล์ CSS หลัก -->
    <link rel="stylesheet" href="create_project.css" />
</head>
<body>
    <!-- คอนเทนเนอร์หลักของหน้า -->
    <div class="page-wrapper">
        <div class="dashboard-container form-view-container">
            
            <!-- ====================================
                 ส่วนหัวของฟอร์ม
                 ==================================== -->
            <header class="form-header">
                <!-- ปุ่มย้อนกลับ -->
                <button class="back-btn" title="Back">
                    <i class="fas fa-arrow-left"></i>
                </button>
                
                <!-- หัวข้อหน้า -->
                <h1 class="header-title">Create Project</h1>
                
                <!-- ช่องว่างเพื่อสมดุล (ให้ชื่ออยู่ตรงกลาง) -->
                <div style="width: 40px;"></div>
            </header>

            <!-- ====================================
                 ฟอร์มสร้างโปรเจค
                 ==================================== -->
            <main class="main-content form-content">
                <form id="project-form" class="project-form">
                    
                    <!-- ชื่อโปรเจค -->
                    <div class="input-group">
                        <label for="projectName">
                            <i class="fas fa-clipboard-list"></i>
                            Project Name
                        </label>
                        <input
                            type="text"
                            id="projectName"
                            placeholder="e.g., DTI326 Mobile App"
                            required
                        />
                    </div>

                    <!-- คำอธิบายโปรเจค -->
                    <div class="input-group">
                        <label for="description">
                            <i class="fas fa-file-alt"></i>
                            Description
                        </label>
                        <textarea
                            id="description"
                            placeholder="Describe your workspace..."
                        ></textarea>
                    </div>

                    <!-- จำนวนสมาชิกสูงสุด -->
                    <div class="input-group member-control-group">
                        <label for="maxMembers">
                            <i class="fas fa-user-friends"></i>
                            Max Members
                        </label>

                        <div class="member-control">
                            <!-- ปุ่มลดจำนวน -->
                            <button
                                type="button"
                                class="control-btn minus-btn"
                                aria-label="Decrease max members"
                            >
                                <i class="fas fa-minus"></i>
                            </button>

                            <!-- ช่องแสดงจำนวน (แก้ไขได้ด้วยปุ่ม +/- เท่านั้น) -->
                            <input
                                type="number"
                                id="maxMembers"
                                value="4"
                                min="1"
                                max="100"
                                readonly
                            />

                            <!-- ปุ่มเพิ่มจำนวน -->
                            <button
                                type="button"
                                class="control-btn plus-btn"
                                aria-label="Increase max members"
                            >
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                    </div>

                    <!-- เชิญสมาชิกผ่านอีเมล -->
                    <div class="input-group">
                        <label>
                            <i class="fas fa-envelope"></i>
                            Invite Members
                        </label>

                        <!-- แสดงรายการอีเมลที่เพิ่มแล้ว -->
                        <div id="email-list"></div>

                        <!-- ช่องกรอกอีเมลใหม่ -->
                        <div class="add-email-container">
                            <input
                                type="email"
                                id="inviteEmail"
                                placeholder="Enter member email"
                            />
                            <button type="button" id="addEmailBtn">
                                <i class="fas fa-plus"></i>
                                Add
                            </button>
                        </div>

                        <!-- Hidden input เก็บรายการอีเมลทั้งหมด -->
                        <input type="hidden" id="membersInput" name="members" />
                    </div>

                    <!-- ปุ่มสร้างโปรเจค -->
                    <div class="form-footer-action">
                        <button type="submit" class="btn-full-width">
                            <i class="fas fa-rocket"></i>
                            Create Project
                        </button>
                    </div>
                </form>
            </main>
        </div>
    </div>

    <!-- ====================================
         JavaScript สำหรับจัดการฟอร์ม
         ==================================== -->
    <script>
        // ====================================
        // เริ่มทำงานเมื่อโหลดหน้าเว็บเสร็จ
        // ====================================
        document.addEventListener("DOMContentLoaded", () => {
            
            // ====================================
            // 1. ดึง Elements จาก DOM
            // ====================================
            const minusBtn = document.querySelector(".minus-btn");
            const plusBtn = document.querySelector(".plus-btn");
            const memberInput = document.getElementById("maxMembers");
            const backBtn = document.querySelector(".back-btn");
            const addEmailBtn = document.getElementById("addEmailBtn");
            const inviteEmail = document.getElementById("inviteEmail");
            const emailList = document.getElementById("email-list");
            const projectForm = document.getElementById("project-form");

            // เก็บรายการอีเมลที่เชิญ
            let emails = [];

            // ====================================
            // 2. ปุ่มเพิ่ม/ลดจำนวนสมาชิก
            // ====================================
            
            // ปุ่มลดจำนวน
            minusBtn.addEventListener("click", () => {
                const currentVal = parseInt(memberInput.value, 10);
                const minVal = parseInt(memberInput.min, 10);

                // ลดได้ถ้ายังไม่ถึงค่าต่ำสุด
                if (currentVal > minVal) {
                    memberInput.value = currentVal - 1;
                }
            });

            // ปุ่มเพิ่มจำนวน
            plusBtn.addEventListener("click", () => {
                const currentVal = parseInt(memberInput.value, 10);
                const maxVal = parseInt(memberInput.max, 10);

                // เพิ่มได้ถ้ายังไม่ถึงค่าสูงสุด
                if (currentVal < maxVal) {
                    memberInput.value = currentVal + 1;
                }
            });

            // ====================================
            // 3. ปุ่มย้อนกลับ
            // ====================================
            backBtn.addEventListener("click", () => {
                window.history.back(); // กลับไปหน้าก่อนหน้า
            });

            // ====================================
            // 4. จัดการรายการอีเมล
            // ====================================
            
            // ฟังก์ชันสร้าง Email Chip (แท็กอีเมล)
            function createEmailChip(email) {
                const chip = document.createElement("div");
                chip.className = "email-chip";
                chip.innerHTML = `
                    <span>${email}</span>
                    <button type="button">×</button>
                `;

                // ปุ่มลบอีเมล
                const removeBtn = chip.querySelector("button");
                removeBtn.addEventListener("click", () => {
                    emailList.removeChild(chip); // ลบ chip ออกจาก DOM
                    emails = emails.filter((e) => e !== email); // ลบออกจาก array
                });

                return chip;
            }

            // ปุ่มเพิ่มอีเมล
            addEmailBtn.addEventListener("click", () => {
                const email = inviteEmail.value.trim();

                // ตรวจสอบว่ากรอกอีเมลหรือไม่
                if (!email) {
                    alert("Please enter an email.");
                    return;
                }

                // ตรวจสอบรูปแบบอีเมล
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                if (!emailRegex.test(email)) {
                    alert("Invalid email format.");
                    return;
                }

                // ตรวจสอบว่าอีเมลซ้ำหรือไม่
                if (emails.includes(email)) {
                    alert("This email is already added.");
                    return;
                }

                // เพิ่มอีเมลเข้า array
                emails.push(email);
                
                // สร้างและแสดง chip
                const emailChip = createEmailChip(email);
                emailList.appendChild(emailChip);
                
                // เคลียร์ช่องกรอก
                inviteEmail.value = "";
            });

            // กด Enter ในช่องอีเมลเพื่อเพิ่มอีเมล
            inviteEmail.addEventListener("keypress", (e) => {
                if (e.key === "Enter") {
                    e.preventDefault();
                    addEmailBtn.click();
                }
            });

            // ====================================
            // 5. Submit ฟอร์ม (สร้างโปรเจค)
            // ====================================
            projectForm.addEventListener("submit", (e) => {
                e.preventDefault(); // ป้องกันการ reload หน้า

                // ดึงข้อมูลจากฟอร์ม
                const projectName = document.getElementById("projectName").value.trim();
                const description = document.getElementById("description").value.trim();
                const maxMembers = memberInput.value;

                // ตรวจสอบว่ากรอกชื่อโปรเจคหรือไม่
                if (!projectName) {
                    alert("Please enter project name.");
                    return;
                }

                // เก็บรายการอีเมลลง hidden input
                document.getElementById("membersInput").value = emails.join(",");

                // ดึง token ของผู้ใช้ปัจจุบัน
                const token = localStorage.getItem("currentUserToken") || 
                             sessionStorage.getItem("currentUserToken");

                // ตรวจสอบว่าได้ล็อกอินหรือไม่
                if (!token) {
                    alert("You must be logged in to create a project.");
                    window.location.href = "login.html";
                    return;
                }

                // โหลดรายการโปรเจคเดิม
                const projects = JSON.parse(localStorage.getItem("projects")) || [];

                // ฟังก์ชันสร้าง ID สุ่ม
                const generateId = () => Math.random().toString(36).substring(2, 9);

                // สร้างโปรเจคใหม่
                const newProject = {
                    id: generateId(),
                    name: projectName,
                    description,
                    maxMembers,
                    ownerToken: token,
                    members: emails,
                    createdAt: new Date().toISOString() // บันทึกวันที่สร้าง
                };

                // เพิ่มโปรเจคใหม่เข้า array
                projects.push(newProject);
                
                // บันทึกลง localStorage
                localStorage.setItem("projects", JSON.stringify(projects));

                // แจ้งเตือนความสำเร็จ
                alert(`Project "${projectName}" created successfully!`);
                
                // กลับไปหน้า Dashboard
                window.location.href = "dashboard.html";
            });
        });
    </script>
</body>
</html>